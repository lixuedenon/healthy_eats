// lib/core/services/ai_recommendation_service.dart
// Dartç±»æ–‡ä»¶

import 'dart:convert';
import 'package:http/http.dart' as http;
import '../../data/models/user_model.dart';
import '../../data/models/recommended_meal_model.dart';
import '../../data/models/token_usage_model.dart';
import '../../data/models/nutrition_model.dart';
import '../../data/repositories/token_stats_repository.dart';

class AIRecommendationService {
  final String _apiKey;
  final TokenStatsRepository _tokenStatsRepository;
  static const String _API_URL = 'https://api.openai.com/v1/chat/completions';

  AIRecommendationService(this._apiKey, this._tokenStatsRepository);

  Future<List<List<RecommendedMeal>>> getTwoRecommendationSets({
    required UserProfile? user,
  }) async {
    return _getRecommendationSets(
      user: user,
      setsCount: 2,
      purpose: 'daily_recommendation_first_batch',
    );
  }

  Future<List<List<RecommendedMeal>>> getThreeRecommendationSets({
    required UserProfile? user,
  }) async {
    return _getRecommendationSets(
      user: user,
      setsCount: 3,
      purpose: 'daily_recommendation_second_batch',
    );
  }

  Future<List<List<RecommendedMeal>>> getFiveRecommendationSets({
    required UserProfile? user,
  }) async {
    return _getRecommendationSets(
      user: user,
      setsCount: 5,
      purpose: 'daily_recommendation_five_sets',
    );
  }

  Future<List<List<RecommendedMeal>>> _getRecommendationSets({
    required UserProfile? user,
    required int setsCount,
    required String purpose,
  }) async {
    try {
      print('ğŸ¤– å¼€å§‹ç”Ÿæˆ $setsCount å¥—æ¨è...');

      final prompt = _buildPrompt(user, setsCount);

      final response = await _callOpenAI(prompt, 'gpt-3.5-turbo');

      final sets = _parseRecommendationSets(response, setsCount);

      final usage = TokenUsage.calculate(
        model: 'gpt-3.5-turbo',
        inputTokens: response['usage']['prompt_tokens'],
        outputTokens: response['usage']['completion_tokens'],
        purpose: purpose,
      );

      await _tokenStatsRepository.saveUsage(usage);

      print('âœ… æˆåŠŸç”Ÿæˆ ${sets.length} å¥—æ¨è');
      print('ğŸ’° æœ¬æ¬¡æˆæœ¬: ${usage.costDisplay}');

      return sets;
    } catch (e) {
      print('âŒ ç”Ÿæˆæ¨èå¤±è´¥: $e');
      rethrow;
    }
  }

  String _buildPrompt(UserProfile? user, int setsCount) {
    if (user == null || !_isProfileComplete(user)) {
      return _getGenericPrompt(setsCount);
    }
    return _getPersonalizedPrompt(user, setsCount);
  }

  bool _isProfileComplete(UserProfile user) {
    return user.age != null &&
        user.healthGoal.isNotEmpty &&
        user.preferredCuisines.isNotEmpty;
  }

  String _getGenericPrompt(int setsCount) {
    return '''
è¯·ä¸ºä¸€èˆ¬äººç¾¤æ¨è${setsCount}å¥—ä¸åŒçš„å¥åº·ä»Šæ—¥ä¸‰é¤æ–¹æ¡ˆï¼ˆæ¯å¥—åŒ…å«æ—©é¤ã€åˆé¤ã€æ™šé¤ï¼‰ã€‚

è¦æ±‚ï¼š
1. æ¯å¥—æ–¹æ¡ˆè¦æœ‰æ˜æ˜¾ä¸åŒçš„é£æ ¼å’Œé£Ÿæ
2. è¥å…»å‡è¡¡ï¼Œé€‚åˆå¤§å¤šæ•°äºº
3. é£Ÿæå¸¸è§ï¼Œå®¹æ˜“è·å–
4. åˆ¶ä½œç®€å•ï¼Œä¸è¶…è¿‡30åˆ†é’Ÿ

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "recommendation_sets": [
    {
      "set_number": 1,
      "set_name": "æ–¹æ¡ˆåç§°ï¼ˆå¦‚ï¼šæ¸…çˆ½å¥åº·å¥—é¤ï¼‰",
      "meals": [
        {
          "mealType": "æ—©é¤",
          "name": "é¤é£Ÿåç§°",
          "description": "ç®€çŸ­æè¿°",
          "ingredients": ["é£Ÿæ1 50g", "é£Ÿæ2 100ml"],
          "nutrition": {
            "calories": 500,
            "protein": 20,
            "carbs": 60,
            "fat": 15,
            "magnesium": 100,
            "vitaminB6": 0.5,
            "omega3": 0.2
          },
          "estimatedROI": 80,
          "cookingTips": "çƒ¹é¥ªå»ºè®®",
          "cookingTime": 15
        },
        {
          "mealType": "åˆé¤",
          ...
        },
        {
          "mealType": "æ™šé¤",
          ...
        }
      ]
    },
    {
      "set_number": 2,
      ...
    }
    ${setsCount > 2 ? '... ï¼ˆå…±$setsCountå¥—ï¼‰' : ''}
  ]
}

è¯·ç›´æ¥è¿”å›JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ã€‚
''';
  }

  String _getPersonalizedPrompt(UserProfile user, int setsCount) {
    final bmiAnalysis = _analyzeBMI(user);
    final healthConditionAnalysis = _analyzeHealthConditions(user);
    final healthGoalStrategy = _getHealthGoalStrategy(user.healthGoal, user);
    final mealSourceInfo = _getMealSourceInfo(user.defaultMealSource);
    final cityPriceInfo = _getCityPriceInfo(user.city, user.defaultMealSource);
    final dishNamingStyle = _getDishNamingStyle(user.defaultMealSource);
    final snackRecommendation = _getSnackRecommendation(user.healthGoal);

    return '''
âš ï¸âš ï¸âš ï¸ ä¸¥é‡è­¦å‘Š âš ï¸âš ï¸âš ï¸

åœ¨å¼€å§‹æ¨èä¹‹å‰ï¼Œè¯·åŠ¡å¿…ç†è§£ä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

1. ç”¨æˆ·çš„é€‰æ‹©å°±æ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼
   - å¦‚æœç”¨æˆ·é€‰æ‹©"èƒ¡åƒæµ·å¡"ï¼Œå°±è¦æ¨èä¸°ç››ç¾å‘³çš„é£Ÿç‰©ï¼Œä¸è¦æ“…è‡ªæ”¹æˆæ¸…æ·¡é¥®é£Ÿ
   - å¦‚æœç”¨æˆ·é€‰æ‹©"åŸºæœ¬å¤–é£Ÿ"ï¼Œå°±è¦æ¨èçœŸå®é¤é¦†èœå“ï¼Œä¸è¦æ¨èå®¶å¸¸èœ
   - å¦‚æœç”¨æˆ·é€‰æ‹©"æ¸…æ±¤å¯¡æ¬²"ï¼Œæ‰æ¨èæ¸…æ·¡é£Ÿç‰©

2. ç¾å‘³ä¸å¥åº·å¹¶é‡ï¼Œè€Œéåªæ³¨é‡å¥åº·ï¼
   - å¥åº·å¾ˆé‡è¦ï¼Œä½†ç¾å‘³åŒæ ·é‡è¦
   - æ ¹æ®ç”¨æˆ·çš„å¥åº·ç›®æ ‡è°ƒæ•´ç¾å‘³ä¸å¥åº·çš„æ¯”ä¾‹
   - "èƒ¡åƒæµ·å¡"ç”¨æˆ·ä¼˜å…ˆç¾å‘³ï¼Œ"å‡è„‚"ç”¨æˆ·æ‰ä¼˜å…ˆå¥åº·

3. æ¨èçœŸå®å­˜åœ¨çš„é¤é¦†èœå“ï¼
   - ä¸è¦è™šæ„èœå“
   - æ¨èç”¨æˆ·èƒ½åœ¨é¤é¦†çœŸå®ç‚¹åˆ°çš„èœ
   - ä»·æ ¼ç¬¦åˆå½“åœ°æ¶ˆè´¹æ°´å¹³

=====================================

ç°åœ¨è¯·ä¸ºä»¥ä¸‹ç”¨æˆ·æ¨è${setsCount}å¥—ä¸åŒçš„ä»Šæ—¥é¤é£Ÿæ–¹æ¡ˆï¼š

=== ç¬¬ä¸€æ­¥ï¼šåˆ†æç”¨æˆ·ç”»åƒ ===

ã€åŸºæœ¬ä¿¡æ¯ã€‘
- æ€§åˆ«ï¼š${user.gender ?? "æœªçŸ¥"}
- å¹´é¾„ï¼š${user.age ?? "æœªçŸ¥"}å²
- èº«é«˜ï¼š${user.height ?? "æœªçŸ¥"}cm
- ä½“é‡ï¼š${user.weight ?? "æœªçŸ¥"}kg
${user.city != null && user.city!.isNotEmpty ? '- åŸå¸‚ï¼š${user.city}' : ''}
${user.bmi != null ? '- BMI: ${user.bmi!.toStringAsFixed(1)}' : ''}

ã€èº«ä½“çŠ¶å†µåˆ†æã€‘
$bmiAnalysis

ã€å¥åº·çŠ¶å†µåˆ†æã€‘
$healthConditionAnalysis

=== ç¬¬äºŒæ­¥ï¼šç†è§£ç”¨æˆ·éœ€æ±‚ ===

ã€å¥åº·ç›®æ ‡ã€‘${user.healthGoal}

â­â­â­ å…³é”®ç†è§£ç‚¹ â­â­â­

$healthGoalStrategy

ã€é¤é£Ÿæ¥æºã€‘${_getMealSourceText(user.defaultMealSource)}

â­â­â­ é¤é£Ÿæ¥æºè¦æ±‚ â­â­â­

$mealSourceInfo

${user.city != null && user.city!.isNotEmpty ? '''
ã€ç”¨æˆ·æ‰€åœ¨åŸå¸‚ã€‘${user.city}

â­â­â­ ä»·æ ¼è¦æ±‚ â­â­â­

$cityPriceInfo
''' : ''}

â­â­â­ èœå“å‘½åé£æ ¼è¦æ±‚ â­â­â­

$dishNamingStyle

ã€èœç³»åå¥½ã€‘${user.preferredCuisines.join('ã€')}
ã€å°±é¤æ–¹å¼ã€‘${user.defaultDiningStyle}
${user.isVegetarian ? 'âš ï¸ ç´ é£Ÿè€…ï¼šæ˜¯' : ''}
${user.hasHighBloodSugar ? 'âš ï¸ è¡€ç³–ç®¡ç†ï¼šéœ€è¦æ§åˆ¶å‡ç³–æŒ‡æ•°' : ''}
${user.getAllAvoidFoods().isNotEmpty ? 'âš ï¸ å¿Œå£ï¼š${user.getAllAvoidFoods().join('ã€')}' : ''}

=== ç¬¬ä¸‰æ­¥ï¼šé›¶é£Ÿæ¨èç­–ç•¥ ===

$snackRecommendation

=== ç¬¬å››æ­¥ï¼šæ¨èç¤ºä¾‹å‚è€ƒ ===

ä¸ºäº†ç¡®ä¿ä½ ç†è§£ç”¨æˆ·çš„çœŸå®éœ€æ±‚ï¼Œè¿™é‡Œæä¾›ä¸€äº›ç¤ºä¾‹ï¼š

ã€ç¤ºä¾‹1ï¼šèƒ¡åƒæµ·å¡ + åŸºæœ¬å¤–é£Ÿ + ä¸­æ—¥è¥¿é¤ã€‘
æ—©é¤ç¤ºä¾‹ï¼šè±†æµ†æ²¹æ¡ã€ç…é¥¼æœå­ã€ç”œç”œåœˆã€çƒ¤é¢åŒ…ç‰‡+åŸ¹æ ¹+æ‹¿é“
åˆé¤ç¤ºä¾‹ï¼šçº¢çƒ§è‚‰ç›–é¥­ã€é±¼é¦™è‚‰ä¸ã€ç‰›è‚‰åœŸè±†ç›–æµ‡é¥­ã€æ³°å›½ç‚’é¥­ã€å¯¿å¸æ‹¼ç›˜ã€åˆºèº«
æ™šé¤ç¤ºä¾‹ï¼šæ°´ç…®é±¼ã€éº»è¾£é¦™é”…ã€çƒ¤é¸­ã€çƒ¤ç‰›æ’+å¥¶é…ªè›‹ç³•ã€å‘³åƒæ‹‰é¢
é›¶é£Ÿç¤ºä¾‹ï¼šå¥¶èŒ¶ã€è›‹ç³•ã€ç‚¸é¸¡

ã€ç¤ºä¾‹2ï¼šå‡è„‚ + è¾ƒå¤šè‡ªå·±åšã€‘
æ—©é¤ç¤ºä¾‹ï¼šç‡•éº¦ç²¥ã€æ°´ç…®è›‹ã€å…¨éº¦é¢åŒ…+ä½è„‚ç‰›å¥¶
åˆé¤ç¤ºä¾‹ï¼šé¸¡èƒ¸è‚‰æ²™æ‹‰ã€æ¸…ç‚’è¥¿å…°èŠ±+ç³™ç±³é¥­ã€è’¸é±¼+å°‘æ²¹é’èœ
æ™šé¤ç¤ºä¾‹ï¼šç•ªèŒ„è±†è…æ±¤ã€è’¸è™¾+è”¬èœã€é¸¡èƒ¸è‚‰ç‚’èŠ¦ç¬‹
é›¶é£Ÿï¼šä¸æ¨è

ã€ç¤ºä¾‹3ï¼šç»´æŒ + å¯¹åŠ + é«˜è¡€å‹ã€‘
æ—©é¤ç¤ºä¾‹ï¼šä½ç›ç²¥ã€è’¸è›‹ã€å…¨éº¦ä¸‰æ˜æ²»ï¼ˆå°‘é…±æ–™ï¼‰
åˆé¤ç¤ºä¾‹ï¼šæ¸…è’¸é±¼ã€å°‘æ²¹å°‘ç›ç‚’èœã€ä½ç›æ±¤é¢ï¼ˆå¤–é£Ÿé€‰æ‹©æ¸…æ·¡é¤å…ï¼‰
æ™šé¤ç¤ºä¾‹ï¼šè‡ªå·±åšçš„æ¸…ç‚–é¸¡æ±¤ã€è’œè“‰è¥¿å…°èŠ±ã€å°‘æ²¹ç‚’è‚‰ç‰‡

=== ç¬¬äº”æ­¥ï¼šç”Ÿæˆä¸ªæ€§åŒ–æ¨è ===

âš ï¸ æœ€åå†æ¬¡å¼ºè°ƒï¼š

1. ä¸¥æ ¼éµå¾ªç”¨æˆ·çš„å¥åº·ç›®æ ‡ï¼ˆ"èƒ¡åƒæµ·å¡"å°±è¦ä¸°ç››ï¼Œ"å‡è„‚"æ‰è¦æ¸…æ·¡ï¼‰
2. ä¸¥æ ¼éµå¾ªé¤é£Ÿæ¥æºï¼ˆ"åŸºæœ¬å¤–é£Ÿ"å°±æ¨èé¤é¦†èœå“ï¼‰
3. ä¸¥æ ¼éµå¾ªèœå“å‘½åé£æ ¼ï¼ˆå¤–é£Ÿç”¨ä¼˜é›…èœåï¼Œè‡ªå·±åšç”¨ç®€å•åç§°ï¼‰
4. é¿å¼€æ‰€æœ‰å¿Œå£é£Ÿæ
5. è€ƒè™‘å¥åº·çŠ¶å†µçš„é£Ÿç‰©ç¦å¿Œ
6. ä»·æ ¼ç¬¦åˆåŸå¸‚æ¶ˆè´¹æ°´å¹³
7. æ¨èçœŸå®å­˜åœ¨çš„é¤é¦†èœå“

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "recommendation_sets": [
    {
      "set_number": 1,
      "set_name": "æ–¹æ¡ˆåç§°",
      "meals": [
        {
          "mealType": "æ—©é¤",
          "name": "é¤é£Ÿåç§°ï¼ˆ${user.defaultMealSource <= 2 ? 'å¤–é£Ÿï¼šä½¿ç”¨ä¼˜é›…èœåï¼Œå¦‚ç¿¡ç¿ ç™½ç‰ç¾¹ã€é»„é‡‘èŠå£«åå¸' : 'è‡ªå·±åšï¼šä½¿ç”¨ç®€å•åç§°ï¼Œå¦‚ç‡•éº¦ç²¥ã€é¸¡è›‹ä¸‰æ˜æ²»'}ï¼‰",
          "description": "ç®€çŸ­æè¿°ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆé€‚åˆç”¨æˆ·",
          "ingredients": ["é£Ÿæ1 50g", "é£Ÿæ2 100ml"],
          "nutrition": {
            "calories": 500,
            "protein": 20,
            "carbs": 60,
            "fat": 15,
            "magnesium": 100,
            "vitaminB6": 0.5,
            "vitaminB12": 1.0,
            "tryptophan": 50,
            "omega3": 0.2
          },
          "estimatedROI": 85,
          "cookingTips": "çƒ¹é¥ªå»ºè®®æˆ–é¤å…å»ºè®®",
          "cookingTime": 20,
          "totalCost": ${user.city != null && user.city!.isNotEmpty ? _getExamplePrice(user.city!, 'breakfast', user.defaultMealSource) : 15}
        },
        {
          "mealType": "åˆé¤",
          "totalCost": ${user.city != null && user.city!.isNotEmpty ? _getExamplePrice(user.city!, 'lunch', user.defaultMealSource) : 30}
          ...
        },
        {
          "mealType": "æ™šé¤",
          "totalCost": ${user.city != null && user.city!.isNotEmpty ? _getExamplePrice(user.city!, 'dinner', user.defaultMealSource) : 25}
          ...
        }
        ${snackRecommendation.shouldRecommend ? ''',
        {
          "mealType": "é›¶é£Ÿ",
          "name": "é›¶é£Ÿåç§°",
          "totalCost": 10
          ...
        }''' : ''}
      ]
    }
    ${setsCount > 1 ? ',\n    { "set_number": 2, ... }' : ''}
    ${setsCount > 2 ? ',\n    ...' : ''}
  ]
}

è¯·ç›´æ¥è¿”å›JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ã€‚
''';
  }

  String _analyzeBMI(UserProfile user) {
    if (user.bmi == null) {
      return '''
âš ï¸ ç”¨æˆ·æœªæä¾›èº«é«˜ä½“é‡ä¿¡æ¯ï¼Œè¯·æŒ‰ç…§ä¸€èˆ¬å¥åº·äººç¾¤æ ‡å‡†æ¨èã€‚
æ¨èç›®æ ‡ï¼šå‡è¡¡è¥å…»ï¼Œæ¯æ—¥çº¦2000 kcalã€‚
''';
    }

    final bmi = user.bmi!;

    if (bmi < 18.5) {
      return '''
ğŸ“Š BMIåˆ†æï¼š${bmi.toStringAsFixed(1)} - åç˜¦

å¥åº·å»ºè®®ï¼š
1. éœ€è¦é€‚å½“å¢åŠ çƒ­é‡æ‘„å…¥ï¼Œå»ºè®®æ¯æ—¥2200-2500 kcal
2. æ³¨é‡ä¼˜è´¨è›‹ç™½è´¨æ‘„å…¥ï¼ˆæ¯æ—¥100-120gï¼‰ï¼Œå¸®åŠ©å¢åŠ è‚Œè‚‰é‡
3. å¢åŠ å¥åº·è„‚è‚ªæ‘„å…¥ï¼ˆåšæœã€ç‰›æ²¹æœã€æ·±æµ·é±¼ï¼‰
4. å°‘é£Ÿå¤šé¤ï¼Œé¿å…å•æ¬¡è¿›é£Ÿè¿‡å¤š
5. æ³¨æ„è¥å…»å¯†åº¦ï¼Œé€‰æ‹©è¥å…»ä¸°å¯Œçš„é£Ÿç‰©

âš ï¸ é‡è¦æç¤ºï¼šå¦‚æœç”¨æˆ·çš„å¥åº·ç›®æ ‡æ˜¯"å‡è„‚"æˆ–"æ¸…æ±¤å¯¡æ¬²"ï¼Œè¯·æ¸©å’Œæé†’ç”¨æˆ·å½“å‰ä½“é‡åè½»ï¼Œå»ºè®®è°ƒæ•´å¥åº·ç›®æ ‡ã€‚ä½†ä»è¦å°Šé‡ç”¨æˆ·é€‰æ‹©ã€‚
''';
    } else if (bmi < 24) {
      return '''
ğŸ“Š BMIåˆ†æï¼š${bmi.toStringAsFixed(1)} - æ­£å¸¸ä½“é‡ âœ“

å¥åº·å»ºè®®ï¼š
1. ä¿æŒå½“å‰è‰¯å¥½çŠ¶æ€ï¼Œå»ºè®®æ¯æ—¥2000-2200 kcal
2. å‡è¡¡æ‘„å…¥è›‹ç™½è´¨ï¼ˆæ¯æ—¥80-100gï¼‰ã€ç¢³æ°´åŒ–åˆç‰©ã€è„‚è‚ª
3. å¤šæ‘„å…¥æ–°é²œè”¬èœæ°´æœï¼Œä¿è¯å¾®é‡è¥å…»ç´ 
4. é€‚é‡è¿åŠ¨ï¼Œç»´æŒå¥åº·ä½“æ€
5. æ ¹æ®å…·ä½“å¥åº·ç›®æ ‡å¾®è°ƒçƒ­é‡æ‘„å…¥

å½“å‰çŠ¶æ€ï¼šä½“é‡åœ¨å¥åº·èŒƒå›´å†…ï¼Œå¯ä»¥æ ¹æ®å¥åº·ç›®æ ‡çµæ´»è°ƒæ•´é¥®é£Ÿç­–ç•¥ã€‚
''';
    } else if (bmi < 28) {
      return '''
ğŸ“Š BMIåˆ†æï¼š${bmi.toStringAsFixed(1)} - åèƒ–

å¥åº·å»ºè®®ï¼š
1. å»ºè®®é€‚å½“æ§åˆ¶çƒ­é‡ï¼Œæ¯æ—¥1800-2000 kcal
2. æé«˜è›‹ç™½è´¨æ¯”ä¾‹ï¼ˆæ¯æ—¥100-120gï¼‰ï¼Œå¢åŠ é¥±è…¹æ„Ÿ
3. å‡å°‘ç²¾åˆ¶ç¢³æ°´åŒ–åˆç‰©ï¼Œé€‰æ‹©å…¨è°·ç‰©å’Œç²—ç²®
4. æ§åˆ¶æ²¹è„‚æ‘„å…¥ï¼Œé¿å…æ²¹ç‚¸å’Œé«˜è„‚é£Ÿç‰©
5. å¢åŠ è†³é£Ÿçº¤ç»´æ‘„å…¥ï¼Œå¤šåƒè”¬èœ

âš ï¸ é‡è¦æç¤ºï¼šå¦‚æœç”¨æˆ·çš„å¥åº·ç›®æ ‡æ˜¯"å¢è‚Œ"æˆ–"èƒ¡åƒæµ·å¡"ï¼Œè¯·æ¸©å’Œæé†’ç”¨æˆ·å½“å‰ä½“é‡åé«˜ï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘å‡è„‚æˆ–ç»´æŒä½“é‡ã€‚ä½†ä»è¦å°Šé‡ç”¨æˆ·é€‰æ‹©ã€‚
''';
    } else {
      return '''
ğŸ“Š BMIåˆ†æï¼š${bmi.toStringAsFixed(1)} - è‚¥èƒ– âš ï¸

å¥åº·å»ºè®®ï¼š
1. éœ€è¦æœ‰æ•ˆæ§åˆ¶çƒ­é‡ï¼Œå»ºè®®æ¯æ—¥1600-1800 kcal
2. é«˜è›‹ç™½é¥®é£Ÿï¼ˆæ¯æ—¥120-140gï¼‰ï¼Œå¸®åŠ©ä¿æŒè‚Œè‚‰é‡
3. ä¸¥æ ¼é™åˆ¶ç²¾åˆ¶ç¢³æ°´å’Œæ·»åŠ ç³–
4. ä½è„‚çƒ¹é¥ªæ–¹å¼ï¼Œé¿å…æ²¹ç‚¸ã€ç…ç‚’
5. å¤§é‡è”¬èœå¢åŠ é¥±è…¹æ„Ÿï¼Œæ§åˆ¶æ€»çƒ­é‡
6. å»ºè®®é…åˆåŒ»ç”Ÿæˆ–è¥å…»å¸ˆæŒ‡å¯¼

âš ï¸ é‡è¦æç¤ºï¼šå¦‚æœç”¨æˆ·çš„å¥åº·ç›®æ ‡æ˜¯"å¢è‚Œ"æˆ–"èƒ¡åƒæµ·å¡"ï¼Œè¯·å¼ºçƒˆå»ºè®®ç”¨æˆ·è°ƒæ•´å¥åº·ç›®æ ‡ä¸º"å‡è„‚"ï¼Œå¹¶åœ¨æ¨èä¸­ä¼˜å…ˆè€ƒè™‘å‡è„‚éœ€æ±‚ã€‚ä½†ä»è¦å°Šé‡ç”¨æˆ·é€‰æ‹©ã€‚
''';
    }
  }

  String _analyzeHealthConditions(UserProfile user) {
    if (!user.hasAnyHealthCondition) {
      return '''
âœ… å¥åº·çŠ¶å†µï¼šæ— ç‰¹æ®Šå¥åº·é—®é¢˜

å¯ä»¥æ ¹æ®ç”¨æˆ·çš„å¥åº·ç›®æ ‡è‡ªç”±æ¨èé£Ÿç‰©ï¼Œæ— éœ€ç‰¹åˆ«é™åˆ¶ã€‚
''';
    }

    final conditions = user.healthConditions.where((c) => c != 'æ— ').toList();

    StringBuffer analysis = StringBuffer();
    analysis.writeln('âš ï¸ å¥åº·çŠ¶å†µï¼š${conditions.join('ã€')}');
    analysis.writeln();
    analysis.writeln('éœ€è¦æ³¨æ„çš„é£Ÿç‰©ç¦å¿Œï¼š');
    analysis.writeln();

    for (var condition in conditions) {
      final restriction = _getHealthConditionRestriction(condition);
      if (restriction != null) {
        analysis.writeln('ã€$conditionã€‘');
        analysis.writeln(restriction);
        analysis.writeln();
      }
    }

    analysis.writeln('âš ï¸ é‡è¦ï¼šè¯·åœ¨æ¨èä¸­ä¸¥æ ¼é¿å¼€ä¸Šè¿°ç¦å¿Œé£Ÿç‰©ï¼Œå¹¶åœ¨æè¿°ä¸­æ¸©å’Œæé†’ç”¨æˆ·æ³¨æ„ç›¸å…³äº‹é¡¹ã€‚');

    return analysis.toString();
  }

  String? _getHealthConditionRestriction(String condition) {
    final restrictions = {
      'é«˜è¡€å‹': '''
- ä¸¥æ ¼æ§åˆ¶ç›åˆ†ï¼šæ¯æ—¥ç›æ‘„å…¥<5g
- é¿å…ï¼šè…Œåˆ¶é£Ÿå“ã€å’¸èœã€ç«è…¿ã€é¦™è‚ ã€é…±æ²¹ï¼ˆå¤§é‡ï¼‰ã€å‘³ç²¾
- é¿å…ï¼šç½å¤´é£Ÿå“ã€å¿«é¤ã€æ–¹ä¾¿é¢
- æ¨èï¼šæ–°é²œè”¬èœã€æ°´æœã€ä½è„‚å¥¶åˆ¶å“ã€å…¨è°·ç‰©
- çƒ¹é¥ªæ–¹å¼ï¼šæ¸…è’¸ã€æ°´ç…®ã€å‡‰æ‹Œï¼Œå°‘ç”¨ç›
''',
      'é«˜è¡€è„‚': '''
- ä¸¥æ ¼æ§åˆ¶è„‚è‚ªï¼šæ¯æ—¥è„‚è‚ª<50g
- é¿å…ï¼šåŠ¨ç‰©å†…è„ã€è‚¥è‚‰ã€æ²¹ç‚¸é£Ÿå“ã€å¥¶æ²¹ã€é»„æ²¹
- é¿å…ï¼šé«˜èƒ†å›ºé†‡é£Ÿç‰©ï¼ˆè›‹é»„ã€é±¿é±¼ã€åŠ¨ç‰©è„‘ï¼‰
- é™åˆ¶ï¼šæ¤ç‰©æ²¹ç”¨é‡
- æ¨èï¼šæ·±æµ·é±¼ã€è±†åˆ¶å“ã€ç‡•éº¦ã€è”¬èœæ°´æœ
- çƒ¹é¥ªæ–¹å¼ï¼šæ¸…è’¸ã€æ°´ç…®ã€å°‘æ²¹ç‚’
''',
      'é«˜è¡€ç³–/ç³–å°¿ç—…': '''
- ä¸¥æ ¼æ§åˆ¶ç¢³æ°´åŒ–åˆç‰©å’Œç³–åˆ†
- é¿å…ï¼šç™½ç³–ã€çº¢ç³–ã€èœ‚èœœã€ç”œç‚¹ã€è›‹ç³•ã€é¥®æ–™
- é¿å…ï¼šé«˜GIé£Ÿç‰©ï¼ˆç™½ç±³é¥­ã€ç™½é¢åŒ…ã€åœŸè±†ã€è¥¿ç“œï¼‰
- é™åˆ¶ï¼šæ°´æœæ‘„å…¥é‡ï¼Œé€‰æ‹©ä½GIæ°´æœ
- æ¨èï¼šç²—ç²®ã€å…¨éº¦ã€è±†ç±»ã€ç»¿å¶è”¬èœã€ä¼˜è´¨è›‹ç™½
- æ³¨æ„ï¼šé¤åè¡€ç³–æ§åˆ¶
''',
      'ç”²äº¢': '''
- ä¸¥æ ¼é¿å…é«˜ç¢˜é£Ÿç‰©
- é¿å…ï¼šæµ·å¸¦ã€ç´«èœã€æµ·è—»ã€æµ·é±¼ã€æµ·è™¾ã€åŠ ç¢˜ç›
- é¿å…ï¼šå«ç¢˜è¯ç‰©å’Œè¡¥å“
- æ¨èï¼šæ–°é²œè”¬èœã€æ°´æœã€æ·¡æ°´é±¼ã€é¸¡è‚‰ã€ç˜¦è‚‰
- æ³¨æ„ï¼šä½¿ç”¨æ— ç¢˜ç›
''',
      'ç”²å‡': '''
- é€‚å½“è¡¥å……ç¢˜
- æ¨èï¼šæµ·å¸¦ã€ç´«èœã€æµ·é±¼ã€åŠ ç¢˜ç›ï¼ˆé€‚é‡ï¼‰
- é¿å…ï¼šç”Ÿç”²çŠ¶è…ºè‚¿é£Ÿç‰©ï¼ˆå¤§é‡ç”Ÿèåœã€ç”Ÿç™½èœï¼‰
- æ³¨æ„ï¼šä¸ç”²äº¢ç›¸åï¼Œéœ€è¦é€‚é‡ç¢˜
''',
      'ç—›é£': '''
- ä¸¥æ ¼é™åˆ¶å˜Œå‘¤æ‘„å…¥
- é¿å…ï¼šåŠ¨ç‰©å†…è„ã€æµ·é²œï¼ˆè™¾èŸ¹è´ç±»ï¼‰ã€æ²™ä¸é±¼ã€å‡¤å°¾é±¼
- é¿å…ï¼šå•¤é…’ã€ç™½é…’ã€æµ“è‚‰æ±¤ã€ç«é”…æ±¤
- é™åˆ¶ï¼šçº¢è‚‰ã€è±†ç±»ï¼ˆé€‚é‡å³å¯ï¼‰
- æ¨èï¼šè”¬èœã€æ°´æœã€ä½è„‚å¥¶åˆ¶å“ã€é¸¡è›‹
- é‡è¦ï¼šå¤šå–æ°´
''',
      'è‚¾ç—…': '''
- ä½è›‹ç™½ã€ä½ç›ã€ä½é’¾é¥®é£Ÿ
- ä¸¥æ ¼æ§åˆ¶è›‹ç™½è´¨ï¼šæ¯æ—¥0.6-0.8g/kgä½“é‡
- é¿å…ï¼šé«˜ç›é£Ÿç‰©ã€è…Œåˆ¶å“ã€åŠ¨ç‰©å†…è„
- é™åˆ¶ï¼šé«˜é’¾é£Ÿç‰©ï¼ˆé¦™è•‰ã€æ©™æ±ã€åœŸè±†ã€è¥¿çº¢æŸ¿ï¼‰
- æ¨èï¼šä¼˜è´¨è›‹ç™½ï¼ˆé¸¡è›‹ã€é±¼ã€ç˜¦è‚‰ï¼Œä½†è¦é™é‡ï¼‰
- æ³¨æ„ï¼šæ¶²ä½“æ‘„å…¥é‡
''',
      'å¿ƒè„ç—…': '''
- ä½è„‚ã€ä½ç›ã€ä½èƒ†å›ºé†‡é¥®é£Ÿ
- é¿å…ï¼šé«˜è„‚è‚ªé£Ÿç‰©ã€æ²¹ç‚¸é£Ÿå“ã€åŠ¨ç‰©å†…è„
- é¿å…ï¼šé«˜ç›é£Ÿç‰©ã€è…Œåˆ¶å“
- é™åˆ¶ï¼šèƒ†å›ºé†‡æ‘„å…¥
- æ¨èï¼šæ·±æµ·é±¼ã€ç‡•éº¦ã€è”¬èœã€æ°´æœã€åšæœï¼ˆé€‚é‡ï¼‰
- æ³¨æ„ï¼šæ§åˆ¶æ€»çƒ­é‡
''',
      'è„‚è‚ªè‚': '''
- ä½è„‚ã€ä½ç³–ã€ä½çƒ­é‡é¥®é£Ÿ
- é¿å…ï¼šæ²¹è…»é£Ÿç‰©ã€æ²¹ç‚¸é£Ÿå“ã€è‚¥è‚‰ã€ç”œé£Ÿ
- é¿å…ï¼šé…’ç²¾ï¼ˆç»å¯¹ç¦æ­¢ï¼‰
- é™åˆ¶ï¼šç²¾åˆ¶ç¢³æ°´åŒ–åˆç‰©
- æ¨èï¼šç²—ç²®ã€è”¬èœã€ç˜¦è‚‰ã€è±†åˆ¶å“
- æ³¨æ„ï¼šæ§åˆ¶æ€»çƒ­é‡ï¼Œå‡è½»ä½“é‡
''',
      'èƒƒç—…': '''
- é¿å…åˆºæ¿€æ€§é£Ÿç‰©
- é¿å…ï¼šè¾›è¾£ã€è¿‡é…¸ã€è¿‡çƒ«ã€ç”Ÿå†·é£Ÿç‰©
- é¿å…ï¼šæµ“èŒ¶ã€å’–å•¡ã€é…’ç²¾ã€ç¢³é…¸é¥®æ–™
- é¿å…ï¼šç²—ç³™ã€éš¾æ¶ˆåŒ–é£Ÿç‰©
- æ¨èï¼šè½¯çƒ‚ã€æ˜“æ¶ˆåŒ–é£Ÿç‰©ã€ç²¥ã€é¢æ¡ã€è’¸è›‹
- æ³¨æ„ï¼šå°‘é£Ÿå¤šé¤ï¼Œç»†åš¼æ…¢å’½
''',
    };

    return restrictions[condition];
  }

  String _getHealthGoalStrategy(String healthGoal, UserProfile user) {
    switch (healthGoal) {
      case 'å‡è„‚':
        return '''
ğŸ¯ å¥åº·ç›®æ ‡ï¼šå‡è„‚

ç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†"å‡è„‚"ç›®æ ‡ï¼Œè¿™æ„å‘³ç€ï¼š
âœ… ç”¨æˆ·å¸Œæœ›æ§åˆ¶çƒ­é‡
âœ… ç”¨æˆ·æ¥å—æ¸…æ·¡çš„é¥®é£Ÿ
âœ… ç”¨æˆ·é‡è§†å¥åº·å¤šäºå£å‘³

è¥å…»ç­–ç•¥ï¼š
1. çƒ­é‡æ§åˆ¶ï¼šåˆ¶é€ é€‚åº¦çƒ­é‡ç¼ºå£ï¼ˆæ¯”åŸºç¡€ä»£è°¢ä½10-20%ï¼‰
2. è›‹ç™½è´¨ï¼šé«˜è›‹ç™½é¥®é£Ÿï¼Œå æ€»çƒ­é‡20-25%ï¼Œä¿æŠ¤è‚Œè‚‰é‡
3. ç¢³æ°´åŒ–åˆç‰©ï¼šé€‚é‡å‡å°‘ï¼Œé€‰æ‹©ä½GIé£Ÿç‰©ï¼Œå æ€»çƒ­é‡40-45%
4. è„‚è‚ªï¼šé€‚é‡æ‘„å…¥å¥åº·è„‚è‚ªï¼Œå æ€»çƒ­é‡30-35%
5. è†³é£Ÿçº¤ç»´ï¼šæ¯æ—¥25-30gï¼Œå¢åŠ é¥±è…¹æ„Ÿ

æ¨èç­–ç•¥ï¼š
- ä¸‰é¤åˆ†é…ï¼šæ—©é¤30%ã€åˆé¤40%ã€æ™šé¤30%
- é¿å…ï¼šæ²¹ç‚¸ã€é«˜ç³–ã€é«˜è„‚é£Ÿç‰©
- æ¨èï¼šé¸¡èƒ¸è‚‰ã€é±¼è‚‰ã€è±†åˆ¶å“ã€ç²—ç²®ã€è”¬èœ
- çƒ¹é¥ªæ–¹å¼ï¼šè’¸ã€ç…®ã€çƒ¤ã€ç‚–
''';

      case 'å¢è‚Œ':
        return '''
ğŸ¯ å¥åº·ç›®æ ‡ï¼šå¢è‚Œ

ç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†"å¢è‚Œ"ç›®æ ‡ï¼Œè¿™æ„å‘³ç€ï¼š
âœ… ç”¨æˆ·éœ€è¦å……è¶³çš„çƒ­é‡å’Œè›‹ç™½è´¨
âœ… ç”¨æˆ·æ¥å—è¾ƒé«˜çƒ­é‡çš„é£Ÿç‰©
âœ… ç”¨æˆ·é‡è§†è¥å…»å¤šäºé™åˆ¶

è¥å…»ç­–ç•¥ï¼š
1. çƒ­é‡ç›ˆä½™ï¼šæ¯”åŸºç¡€ä»£è°¢é«˜10-15%ï¼Œæ”¯æŒè‚Œè‚‰ç”Ÿé•¿
2. è›‹ç™½è´¨ï¼šé«˜è›‹ç™½é¥®é£Ÿï¼Œæ¯æ—¥1.6-2.0g/kgä½“é‡
3. ç¢³æ°´åŒ–åˆç‰©ï¼šå……è¶³æ‘„å…¥ï¼Œå æ€»çƒ­é‡45-50%ï¼Œæä¾›èƒ½é‡
4. è„‚è‚ªï¼šé€‚é‡æ‘„å…¥ï¼Œå æ€»çƒ­é‡25-30%
5. è®­ç»ƒåè¥å…»ï¼šåŠæ—¶è¡¥å……è›‹ç™½è´¨å’Œç¢³æ°´

æ¨èç­–ç•¥ï¼š
- ä¸‰é¤åˆ†é…ï¼šæ—©é¤25%ã€åˆé¤35%ã€æ™šé¤30%ã€åŠ é¤10%
- é‡ç‚¹ï¼šä¼˜è´¨è›‹ç™½ï¼ˆé¸¡è›‹ã€ç˜¦è‚‰ã€é±¼ã€å¥¶åˆ¶å“ï¼‰
- æ¨èï¼šå¤åˆç¢³æ°´ï¼ˆç‡•éº¦ã€ç³™ç±³ã€çº¢è–¯ã€å…¨éº¦é¢åŒ…ï¼‰
- è¡¥å……ï¼šåšæœã€ç‰›æ²¹æœç­‰å¥åº·è„‚è‚ª
''';

      case 'ç»´æŒ':
        return '''
ğŸ¯ å¥åº·ç›®æ ‡ï¼šç»´æŒ

ç”¨æˆ·é€‰æ‹©äº†"ç»´æŒ"ç›®æ ‡ï¼Œè¿™æ„å‘³ç€ï¼š
âœ… ç”¨æˆ·å¸Œæœ›ä¿æŒå½“å‰çŠ¶æ€
âœ… ç”¨æˆ·æ¥å—å‡è¡¡çš„é¥®é£Ÿ
âœ… ç”¨æˆ·é‡è§†å¥åº·ä¸ç¾å‘³çš„å¹³è¡¡

è¥å…»ç­–ç•¥ï¼š
1. çƒ­é‡å¹³è¡¡ï¼šæ‘„å…¥ä¸æ¶ˆè€—ç›¸ç­‰ï¼Œç»´æŒå½“å‰ä½“é‡
2. è›‹ç™½è´¨ï¼šé€‚é‡æ‘„å…¥ï¼Œå æ€»çƒ­é‡15-20%
3. ç¢³æ°´åŒ–åˆç‰©ï¼šå‡è¡¡æ‘„å…¥ï¼Œå æ€»çƒ­é‡50-55%
4. è„‚è‚ªï¼šé€‚é‡æ‘„å…¥ï¼Œå æ€»çƒ­é‡25-30%
5. å¾®é‡è¥å…»ç´ ï¼šå…¨é¢å‡è¡¡

æ¨èç­–ç•¥ï¼š
- ä¸‰é¤åˆ†é…ï¼šæ—©é¤25%ã€åˆé¤35%ã€æ™šé¤30%ã€é›¶é£Ÿ10%
- å¤šæ ·åŒ–ï¼šå„ç±»é£Ÿç‰©éƒ½é€‚é‡æ‘„å…¥
- æ¨èï¼šå‡è¡¡é¥®é£Ÿï¼Œäº”è°·æ‚ç²®ã€è‚‰è›‹å¥¶ã€è”¬èœæ°´æœ
- åŸåˆ™ï¼šä¸è¿‡åº¦é™åˆ¶ï¼Œä¿æŒè¥å…»å‡è¡¡
''';

      case 'éšæ„':
        return '''
ğŸ¯ å¥åº·ç›®æ ‡ï¼šéšæ„

ç”¨æˆ·é€‰æ‹©äº†"éšæ„"ç›®æ ‡ï¼Œè¿™æ„å‘³ç€ï¼š
âœ… ç”¨æˆ·ä¸æƒ³è¢«ä¸¥æ ¼é™åˆ¶
âœ… ç”¨æˆ·å¸Œæœ›äº«å—ç¾é£Ÿ
âœ… ç”¨æˆ·é‡è§†æ»¡è¶³æ„Ÿå¤šäºä¸¥æ ¼çš„å¥åº·æ ‡å‡†

è¥å…»ç­–ç•¥ï¼š
1. çµæ´»è‡ªç”±ï¼šä¸ä¸¥æ ¼é™åˆ¶çƒ­é‡å’Œè¥å…»ç´ æ¯”ä¾‹
2. å¥åº·å¯¼å‘ï¼šåœ¨è‡ªç”±çš„åŸºç¡€ä¸Šæ³¨é‡è¥å…»å‡è¡¡
3. å¤šæ ·åŒ–ï¼šé¼“åŠ±å°è¯•ä¸åŒé£å‘³å’Œèœç³»
4. äº«å—ç¾é£Ÿï¼šæ³¨é‡é£Ÿç‰©çš„ç¾å‘³å’Œæ»¡è¶³æ„Ÿ
5. é€‚åº¦åŸåˆ™ï¼šé¿å…æç«¯é¥®é£Ÿ

æ¨èç­–ç•¥ï¼š
- ä¸‰é¤åˆ†é…ï¼šçµæ´»å®‰æ’ï¼Œæ— ä¸¥æ ¼é™åˆ¶
- é£æ ¼ï¼šå¤šæ ·åŒ–ï¼ŒåŒ…æ‹¬å„ç§èœç³»å’Œçƒ¹é¥ªæ–¹å¼
- æ¨èï¼šç¾å‘³ä¸å¥åº·å…¼é¡¾
- åŸåˆ™ï¼šäº«å—ç¾é£Ÿçš„åŒæ—¶ï¼Œä¿æŒåŸºæœ¬çš„è¥å…»å¹³è¡¡
''';

      case 'èƒ¡åƒæµ·å¡':
        String warningMessage = '';
        if (user.bmi != null && user.bmi! >= 24) {
          warningMessage = '''

âš ï¸âš ï¸âš ï¸ å¥åº·æé†’ âš ï¸âš ï¸âš ï¸
ç”¨æˆ·å½“å‰BMIä¸º${user.bmi!.toStringAsFixed(1)}ï¼ˆ${user.bmiRating}ï¼‰ï¼Œé€‰æ‹©"èƒ¡åƒæµ·å¡"å¯èƒ½ä¸åˆ©äºå¥åº·ã€‚
å»ºè®®åœ¨æ¨èä¸­æ¸©å’Œæé†’ç”¨æˆ·ï¼Œä½†ä»è¦å°Šé‡ç”¨æˆ·çš„é€‰æ‹©ï¼Œæ¨èä¸°ç››ç¾é£Ÿã€‚
''';
        }

        return '''
ğŸ¯ å¥åº·ç›®æ ‡ï¼šèƒ¡åƒæµ·å¡ ğŸ–

â­â­â­ æ ¸å¿ƒç†è§£ â­â­â­

ç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†"èƒ¡åƒæµ·å¡"ï¼Œè¿™æ˜¯æœ€å…³é”®çš„ä¿¡æ¯ï¼è¿™æ„å‘³ç€ï¼š
âœ… ç”¨æˆ·å°±æ˜¯æƒ³åƒå¥½åƒçš„ï¼
âœ… ç”¨æˆ·ä¸åœ¨ä¹çƒ­é‡é™åˆ¶ï¼
âœ… ç”¨æˆ·è¿½æ±‚ç¾å‘³å’Œæ»¡è¶³æ„Ÿï¼
âœ… ç”¨æˆ·æ¥å—é«˜çƒ­é‡ã€é«˜è„‚è‚ªã€é«˜ç³–çš„é£Ÿç‰©ï¼

è¯·åŠ¡å¿…æ¨èä¸°ç››ã€ç¾å‘³ã€æ»¡è¶³æ„Ÿå¼ºçš„é£Ÿç‰©ï¼

è¥å…»ç­–ç•¥ï¼ˆäº«å—ç¾é£Ÿæ¨¡å¼ï¼‰ï¼š
1. çƒ­é‡ä¸é™ï¼šè¿½æ±‚ç¾å‘³å’Œæ»¡è¶³æ„Ÿï¼Œçƒ­é‡3000+ kcalå®Œå…¨å¯ä»¥
2. è›‹ç™½è´¨ï¼šå……è¶³æ‘„å…¥ï¼Œäº«å—å„ç§è‚‰ç±»å’Œæµ·é²œ
3. ç¢³æ°´åŒ–åˆç‰©ï¼šè‡ªç”±æ‘„å…¥ï¼Œä¸»é£Ÿå……è¶³ï¼Œæƒ³åƒå¤šå°‘åƒå¤šå°‘
4. è„‚è‚ªï¼šä¸é™åˆ¶ï¼Œäº«å—ç¾é£Ÿçš„é¦™æ°”å’Œå£æ„Ÿ
5. ç”œç‚¹é›¶é£Ÿï¼šéšå¿ƒæ‰€æ¬²ï¼Œæƒ³åƒå°±åƒ

æ¨èç­–ç•¥ï¼š
- ä¸‰é¤åˆ†é…ï¼šçµæ´»ï¼Œå¯ä»¥å¤§ä»½é‡ã€å¤šåŠ é¤
- é£æ ¼ï¼šä¸°ç››ã€ç¾å‘³ã€æ»¡è¶³
- æ¨èï¼šå„ç§ç¾é£Ÿï¼ˆçƒ¤è‚‰ã€ç«é”…ã€å¤§é¤ã€ç”œç‚¹ã€å¥¶èŒ¶ï¼‰
- çƒ¹é¥ªæ–¹å¼ï¼šç…ç‚¸ç‚’çƒ¤éƒ½å¯ä»¥ï¼Œæ€ä¹ˆå¥½åƒæ€ä¹ˆæ¥
- å¤–é£Ÿæ¨èï¼šçœŸå®çš„é¤é¦†èœå“ï¼ˆçº¢çƒ§è‚‰ã€æ°´ç…®é±¼ã€çƒ¤é¸­ã€ç‰›æ’ã€ç«é”…ï¼‰

å…·ä½“æ¨èç¤ºä¾‹ï¼š
- æ—©é¤ï¼šè±†æµ†æ²¹æ¡ã€ç…é¥¼æœå­ã€åŸ¹æ ¹é¸¡è›‹ã€ç”œç”œåœˆã€å¥¶èŒ¶
- åˆé¤ï¼šçº¢çƒ§è‚‰ã€é±¼é¦™è‚‰ä¸ã€éº»å©†è±†è…ã€çƒ¤è‚‰ã€ç«é”…ã€ç‰›æ’
- æ™šé¤ï¼šæ°´ç…®é±¼ã€éº»è¾£é¦™é”…ã€çƒ¤é¸­ã€æŠ«è¨ã€ç‚¸é¸¡ã€æ±‰å ¡
- é›¶é£Ÿï¼šè›‹ç³•ã€å†°æ·‡æ·‹ã€å¥¶èŒ¶ã€è–¯ç‰‡ã€ç‚¸é¸¡

$warningMessage

ç‰¹åˆ«è¯´æ˜ï¼šè™½ç„¶ç”¨æˆ·é€‰æ‹©äº†"èƒ¡åƒæµ·å¡"ï¼Œä½†ä»éœ€åœ¨ç¾é£Ÿä¸­å°½é‡å¹³è¡¡è¥å…»ï¼Œé¿å…æç«¯ä¸å¥åº·çš„æ­é…ã€‚
''';

      case 'æ¸…æ±¤å¯¡æ¬²':
        return '''
ğŸ¯ å¥åº·ç›®æ ‡ï¼šæ¸…æ±¤å¯¡æ¬² ğŸ¥—

ç”¨æˆ·é€‰æ‹©äº†"æ¸…æ±¤å¯¡æ¬²"ç›®æ ‡ï¼Œè¿™æ„å‘³ç€ï¼š
âœ… ç”¨æˆ·è¿½æ±‚æ¸…æ·¡é¥®é£Ÿ
âœ… ç”¨æˆ·æ¥å—ä½çƒ­é‡æ‘„å…¥
âœ… ç”¨æˆ·é‡è§†å…»ç”Ÿå’Œå¥åº·

è¥å…»ç­–ç•¥ï¼ˆæ¸…æ·¡é¥®é£Ÿæ¨¡å¼ï¼‰ï¼š
1. çƒ­é‡æ§åˆ¶ï¼šè¾ƒä½çƒ­é‡æ‘„å…¥ï¼Œçº¦1400-1600 kcal
2. è›‹ç™½è´¨ï¼šé€‚é‡æ‘„å…¥ï¼Œä»¥æ¤ç‰©è›‹ç™½å’Œç™½è‚‰ä¸ºä¸»
3. ç¢³æ°´åŒ–åˆç‰©ï¼šå‡å°‘æ‘„å…¥ï¼Œé€‰æ‹©ç²—ç²®å’Œè”¬èœ
4. è„‚è‚ªï¼šæä½è„‚ï¼Œå°‘æ²¹çƒ¹é¥ª
5. ç´ é£Ÿä¸ºä¸»ï¼šå¤§é‡è”¬èœã€é€‚é‡æ°´æœ

æ¨èç­–ç•¥ï¼š
- ä¸‰é¤åˆ†é…ï¼šæ—©é¤25%ã€åˆé¤40%ã€æ™šé¤35%
- é£æ ¼ï¼šæ¸…æ·¡ã€å°‘æ²¹å°‘ç›ã€åŸå‘³
- æ¨èï¼šè”¬èœæ²™æ‹‰ã€æ¸…è’¸é±¼ã€ç™½ç¼è™¾ã€æ¸…ç‚’æ—¶è”¬ã€ç²—ç²®ç²¥
- çƒ¹é¥ªæ–¹å¼ï¼šè’¸ã€ç…®ã€ç‚–ã€ç™½ç¼
- é¿å…ï¼šæ²¹ç‚¸ã€é‡æ²¹ã€é‡ç›ã€é‡ç³–

âš ï¸ é‡è¦æé†’ï¼šè¯·åœ¨æ¨èä¸­æ¸©å’Œæé†’ç”¨æˆ·ï¼Œé•¿æœŸè¿‡åº¦æ¸…æ·¡é¥®é£Ÿå¯èƒ½å¯¼è‡´è¥å…»ä¸è‰¯ï¼Œå»ºè®®é€‚é‡æ‘„å…¥ä¼˜è´¨è›‹ç™½è´¨å’Œå¥åº·è„‚è‚ªã€‚

ç‰¹åˆ«è¯´æ˜ï¼šå³ä½¿æ˜¯æ¸…æ·¡é¥®é£Ÿï¼Œä¹Ÿè¦ä¿è¯åŸºæœ¬çš„è¥å…»éœ€æ±‚ï¼Œé¿å…æç«¯é¥®é£Ÿå¸¦æ¥çš„å¥åº·é£é™©ã€‚
''';

      default:
        return '''
ğŸ¯ å¥åº·ç›®æ ‡ï¼šç»´æŒ

è¥å…»ç­–ç•¥ï¼š
1. çƒ­é‡å¹³è¡¡ï¼šæ‘„å…¥ä¸æ¶ˆè€—ç›¸ç­‰
2. å‡è¡¡æ‘„å…¥å„ç±»è¥å…»ç´ 
3. ä¿æŒå¥åº·çš„é¥®é£Ÿä¹ æƒ¯
''';
    }
  }

  String _getMealSourceInfo(int mealSource) {
    switch (mealSource) {
      case 1:
        return '''
é¤é£Ÿæ¥æºåå¥½ï¼šåŸºæœ¬å¤–é£Ÿï¼ˆLevel 1ï¼‰

â­â­â­ è¿™æ„å‘³ç€ç”¨æˆ·å‡ ä¹æ‰€æœ‰é¤é£Ÿéƒ½åœ¨å¤–é¢åƒï¼â­â­â­

æ¨èé‡ç‚¹ï¼š
- å¿…é¡»æ¨èçœŸå®çš„é¤é¦†èœå“ï¼Œä¸è¦æ¨èéœ€è¦è‡ªå·±åšçš„èœ
- æ¨èç”¨æˆ·èƒ½åœ¨é¤é¦†çœŸå®ç‚¹åˆ°çš„èœ
- ä½¿ç”¨é¤é¦†å¸¸ç”¨çš„ä¼˜é›…èœåï¼ˆå‚è€ƒåæ–‡çš„å‘½åé£æ ¼è¦æ±‚ï¼‰
- è€ƒè™‘å¤–é£Ÿçš„ä¾¿æ·æ€§å’Œå¯è·å¾—æ€§
- ä»·æ ¼ç¬¦åˆå½“åœ°æ¶ˆè´¹æ°´å¹³
- æ³¨æ„æ§åˆ¶å¤–é£Ÿçš„æ²¹ç›æ‘„å…¥ï¼ˆé™¤éç”¨æˆ·é€‰æ‹©"èƒ¡åƒæµ·å¡"ï¼‰

ç¤ºä¾‹æ¨èï¼š
- æ—©é¤ï¼šè±†æµ†æ²¹æ¡ã€ç…é¥¼æœå­ã€è‚ ç²‰ã€æ‹¿é“+å¯é¢‚
- åˆé¤ï¼šé±¼é¦™è‚‰ä¸ã€å®«ä¿é¸¡ä¸ã€çº¢çƒ§è‚‰ã€å¯¿å¸æ‹¼ç›˜ã€ç‰›æ’
- æ™šé¤ï¼šæ°´ç…®é±¼ã€éº»è¾£é¦™é”…ã€çƒ¤é¸­ã€å‘³åƒæ‹‰é¢
''';
      case 2:
        return '''
é¤é£Ÿæ¥æºåå¥½ï¼šè¾ƒå¤šå¤–é£Ÿï¼ˆLevel 2ï¼‰

æ¨èé‡ç‚¹ï¼š
- ä»¥å¤–é£Ÿä¸ºä¸»ï¼Œé€‚å½“æ­é…ç®€å•è‡ªåˆ¶
- æ¨èé¤é¦†èœå“ã€å¿«é¤ã€è½»é£Ÿã€ä¾¿å½“ç­‰ä¾¿æ·é€‰é¡¹
- å¤–é£Ÿéƒ¨åˆ†ä½¿ç”¨ä¼˜é›…èœå
- æä¾›å¥åº·å¤–é£Ÿé€‰æ‹©å»ºè®®
- ä»·æ ¼ç¬¦åˆå½“åœ°æ¶ˆè´¹æ°´å¹³
''';
      case 3:
        return '''
é¤é£Ÿæ¥æºåå¥½ï¼šå¤–é£Ÿä¸è‡ªåˆ¶å„åŠï¼ˆLevel 3ï¼‰

æ¨èé‡ç‚¹ï¼š
- å¹³è¡¡å¤–é£Ÿå’Œè‡ªåˆ¶é¤é£Ÿ
- è‡ªåˆ¶éƒ¨åˆ†é€‰æ‹©ç®€å•å¿«æ‰‹èœ
- å¤–é£Ÿéƒ¨åˆ†æä¾›å¥åº·é€‰æ‹©å»ºè®®
- å¤–é£Ÿèœå“ä½¿ç”¨ä¼˜é›…èœåï¼Œè‡ªåˆ¶èœå“ä½¿ç”¨ç®€å•åç§°
''';
      case 4:
        return '''
é¤é£Ÿæ¥æºåå¥½ï¼šè¾ƒå¤šè‡ªå·±åšï¼ˆLevel 4ï¼‰

æ¨èé‡ç‚¹ï¼š
- ä»¥å®¶åº­çƒ¹é¥ªä¸ºä¸»
- æä¾›è¯¦ç»†é£Ÿææ¸…å•å’Œç®€å•çƒ¹é¥ªå»ºè®®
- é€‚å½“æ­é…å¶å°”å¤–é£Ÿ
- èœå“å‘½åä½¿ç”¨ç®€å•ç›´ç™½çš„æ–¹å¼
''';
      case 5:
        return '''
é¤é£Ÿæ¥æºåå¥½ï¼šåŸºæœ¬è‡ªå·±åšï¼ˆLevel 5ï¼‰

æ¨èé‡ç‚¹ï¼š
- å…¨éƒ¨æ¨èå®¶åº­çƒ¹é¥ªèœå“
- æä¾›å®Œæ•´çš„é£Ÿææ¸…å•å’Œçƒ¹é¥ªæ–¹æ³•
- æ³¨é‡è¥å…»æ­é…å’Œçƒ¹é¥ªæŠ€å·§
- è€ƒè™‘é£Ÿæçš„å¸¸è§æ€§å’Œæ˜“è´­æ€§
- èœå“å‘½åä½¿ç”¨ç®€å•ç›´ç™½çš„æ–¹å¼
''';
      default:
        return '''
é¤é£Ÿæ¥æºåå¥½ï¼šçµæ´»å®‰æ’
æ¨èé‡ç‚¹ï¼š
- æ ¹æ®å®é™…æƒ…å†µçµæ´»è°ƒæ•´
''';
    }
  }

  String _getCityPriceInfo(String? city, int mealSource) {
    if (city == null || city.isEmpty) {
      return '';
    }

    if (mealSource >= 4) {
      return '''
ä»·æ ¼ç­–ç•¥ï¼šç”¨æˆ·ä¸»è¦è‡ªå·±åšé¥­ï¼Œè¯·å‚è€ƒå½“åœ°é£Ÿææˆæœ¬ä¼°ç®—ä»·æ ¼ã€‚
''';
    }

    final priceInfo = _getCityPriceReference(city);

    return '''
å¤–é£Ÿä»·æ ¼å‚è€ƒï¼ˆåŸºäº${city}çš„æ¶ˆè´¹æ°´å¹³ï¼‰ï¼š
$priceInfo

âš ï¸ é‡è¦ï¼šè¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ä»·æ ¼åŒºé—´æ¨èé¤é£Ÿï¼Œç¡®ä¿ä»·æ ¼ç¬¦åˆå½“åœ°æ¶ˆè´¹æ°´å¹³ã€‚
ä¸è¦æ¨èæ˜æ˜¾è¶…å‡ºå½“åœ°æ¶ˆè´¹æ°´å¹³çš„æ˜‚è´µé¤é£Ÿï¼Œä¹Ÿä¸è¦æ¨èè¿‡äºå»‰ä»·çš„é£Ÿç‰©ã€‚
''';
  }

  String _getCityPriceReference(String city) {
    final cityLower = city.toLowerCase();

    if (cityLower.contains('æ—§é‡‘å±±') || cityLower.contains('san francisco') ||
        cityLower.contains('æ¹¾åŒº') || cityLower.contains('bay area') ||
        cityLower.contains('ç¡…è°·') || cityLower.contains('silicon valley') ||
        cityLower.contains('palo alto') || cityLower.contains('mountain view')) {
      return '''
- æ—©é¤ï¼š\$12-20
- åˆé¤ï¼š\$15-25ï¼ˆå¿«é¤ï¼‰ã€\$25-40ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼š\$20-35ï¼ˆå¿«é¤ï¼‰ã€\$35-60ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼š\$5-10
''';
    } else if (cityLower.contains('æ´›æ‰çŸ¶') || cityLower.contains('los angeles') ||
               cityLower.contains('la') || cityLower.contains('å¥½è±å') ||
               cityLower.contains('hollywood')) {
      return '''
- æ—©é¤ï¼š\$8-15
- åˆé¤ï¼š\$12-20ï¼ˆå¿«é¤ï¼‰ã€\$20-35ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼š\$15-25ï¼ˆå¿«é¤ï¼‰ã€\$25-45ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼š\$4-8
''';
    } else if (cityLower.contains('å‡¤å‡°åŸ') || cityLower.contains('phoenix')) {
      return '''
- æ—©é¤ï¼š\$6-12
- åˆé¤ï¼š\$10-15ï¼ˆå¿«é¤ï¼‰ã€\$15-25ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼š\$12-20ï¼ˆå¿«é¤ï¼‰ã€\$20-35ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼š\$3-6
''';
    } else if (cityLower.contains('çº½çº¦') || cityLower.contains('new york') ||
               cityLower.contains('nyc') || cityLower.contains('æ›¼å“ˆé¡¿') ||
               cityLower.contains('manhattan')) {
      return '''
- æ—©é¤ï¼š\$10-18
- åˆé¤ï¼š\$15-25ï¼ˆå¿«é¤ï¼‰ã€\$25-40ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼š\$20-30ï¼ˆå¿«é¤ï¼‰ã€\$30-55ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼š\$5-10
''';
    } else if (cityLower.contains('è¥¿é›…å›¾') || cityLower.contains('seattle')) {
      return '''
- æ—©é¤ï¼š\$10-16
- åˆé¤ï¼š\$13-22ï¼ˆå¿«é¤ï¼‰ã€\$22-38ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼š\$18-28ï¼ˆå¿«é¤ï¼‰ã€\$28-50ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼š\$4-9
''';
    } else if (cityLower.contains('åŒ—äº¬') || cityLower.contains('beijing')) {
      return '''
- æ—©é¤ï¼šÂ¥15-30
- åˆé¤ï¼šÂ¥25-45ï¼ˆå¿«é¤ï¼‰ã€Â¥50-80ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼šÂ¥30-50ï¼ˆå¿«é¤ï¼‰ã€Â¥60-100ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼šÂ¥10-20
''';
    } else if (cityLower.contains('ä¸Šæµ·') || cityLower.contains('shanghai')) {
      return '''
- æ—©é¤ï¼šÂ¥15-35
- åˆé¤ï¼šÂ¥30-50ï¼ˆå¿«é¤ï¼‰ã€Â¥60-100ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼šÂ¥35-60ï¼ˆå¿«é¤ï¼‰ã€Â¥70-120ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼šÂ¥12-25
''';
    } else if (cityLower.contains('æ·±åœ³') || cityLower.contains('shenzhen')) {
      return '''
- æ—©é¤ï¼šÂ¥15-30
- åˆé¤ï¼šÂ¥25-45ï¼ˆå¿«é¤ï¼‰ã€Â¥50-85ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼šÂ¥30-55ï¼ˆå¿«é¤ï¼‰ã€Â¥60-110ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼šÂ¥10-22
''';
    } else if (cityLower.contains('å¹¿å·') || cityLower.contains('guangzhou')) {
      return '''
- æ—©é¤ï¼šÂ¥10-25
- åˆé¤ï¼šÂ¥20-40ï¼ˆå¿«é¤ï¼‰ã€Â¥45-75ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼šÂ¥25-50ï¼ˆå¿«é¤ï¼‰ã€Â¥55-95ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼šÂ¥8-18
''';
    } else {
      return '''
- æ—©é¤ï¼šÂ¥15-30 æˆ– \$8-15
- åˆé¤ï¼šÂ¥30-50 æˆ– \$12-20ï¼ˆå¿«é¤ï¼‰ã€Â¥60-90 æˆ– \$20-35ï¼ˆæ­£é¤ï¼‰
- æ™šé¤ï¼šÂ¥35-60 æˆ– \$15-25ï¼ˆå¿«é¤ï¼‰ã€Â¥70-120 æˆ– \$25-45ï¼ˆæ­£é¤ï¼‰
- é›¶é£Ÿï¼šÂ¥10-20 æˆ– \$4-8
''';
    }
  }

  String _getDishNamingStyle(int mealSource) {
    if (mealSource <= 2) {
      return '''
â­â­â­ å¤–é£Ÿèœå“å‘½åé£æ ¼ï¼ˆåŸºæœ¬å¤–é£Ÿ/è¾ƒå¤šå¤–é£Ÿï¼‰â­â­â­

ç”¨æˆ·ä¸»è¦åœ¨å¤–é¢åƒï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨é¤é¦†å¸¸ç”¨çš„ä¼˜é›…ã€æœ‰æ„å¢ƒã€å¯Œæœ‰æ–‡åŒ–å†…æ¶µçš„èœåï¼

âœ… å¿…é¡»ä½¿ç”¨ä¼˜é›…ã€æœ‰æ„å¢ƒã€å¯Œæœ‰æ–‡åŒ–å†…æ¶µçš„èœå

ä¼˜ç§€ç¤ºä¾‹ï¼ˆä¸­é¤ï¼‰ï¼š
- ç¿¡ç¿ ç™½ç‰ç¾¹ï¼ˆè èœè±†è…æ±¤ï¼‰
- ç«å±±å †ç™½é›ªï¼ˆç•ªèŒ„ç‚’è›‹ï¼‰
- é±¼é¦™è‚‰ä¸
- å®«ä¿é¸¡ä¸
- æ°´æ™¶è‚˜å­
- æ¢…èœæ‰£è‚‰
- é‡‘æ²™ç‰ç±³
- èš‚èšä¸Šæ ‘
- ä¸œå¡è‚‰
- è¥¿æ¹–é†‹é±¼
- é¾™äº•è™¾ä»
- æ¾é¼ æ¡‚é±¼
- ä½›è·³å¢™
- å¤«å¦»è‚ºç‰‡
- éº»å©†è±†è…
- çº¢çƒ§ç‹®å­å¤´

ä¼˜ç§€ç¤ºä¾‹ï¼ˆè¥¿é¤ï¼‰ï¼š
- é»„é‡‘èŠå£«åå¸
- ç»å…¸å‡¯æ’’æ²™æ‹‰
- é¦™ç…è¥¿å†·ç‰›æ’
- å¥¶æ²¹è˜‘è‡æ±¤
- æ„å¼è‚‰é…±é¢
- æ³•å¼ç„—èœ—ç‰›
- ææ‹‰ç±³è‹

ä¼˜ç§€ç¤ºä¾‹ï¼ˆæ—¥é¤ï¼‰ï¼š
- åˆºèº«æ‹¼ç›˜
- å¯¿å¸å·
- ç…§çƒ§é¸¡è‚‰é¥­
- å¤©å¦‡ç½—ç››åˆ
- å‘³åƒæ‹‰é¢

âŒ é¿å…ä½¿ç”¨çš„åç§°ï¼ˆå¤ªç›´ç™½ï¼Œä¸åƒé¤é¦†èœå“ï¼‰ï¼š
- ç•ªèŒ„ç‚’é¸¡è›‹ï¼ˆå¤ªç›´ç™½ï¼‰
- ç‚’é’èœï¼ˆå¤ªç®€å•ï¼‰
- ç…®é¢æ¡ï¼ˆæ— æ„å¢ƒï¼‰
- è’¸é±¼ï¼ˆå¤ªå¹³æ·¡ï¼‰
- ç…®é¸¡è›‹ï¼ˆå¤ªå®¶å¸¸ï¼‰

å¤–é£Ÿèœå“å‘½ååŸåˆ™ï¼š
1. ä½¿ç”¨å½¢è±¡åŒ–ã€è¯—æ„åŒ–çš„æè¿°
2. çªå‡ºèœå“çš„è‰²ã€é¦™ã€å‘³ã€å½¢
3. ä½“ç°çƒ¹é¥ªæŠ€æ³•å’Œæ–‡åŒ–å†…æ¶µ
4. è®©äººä¸€å¬å°±æœ‰é£Ÿæ¬²å’ŒæœŸå¾…æ„Ÿ
5. ç¬¦åˆé¤é¦†èœå•çš„å‘½åä¹ æƒ¯
''';
    } else if (mealSource == 3) {
      return '''
æ··åˆèœå“å‘½åé£æ ¼ï¼ˆå¤–é£Ÿä¸è‡ªåˆ¶å„åŠï¼‰ï¼š
- å¤–é£Ÿéƒ¨åˆ†ï¼šä½¿ç”¨ä¼˜é›…çš„èœåï¼ˆå¦‚ï¼šç¿¡ç¿ ç™½ç‰ç¾¹ã€é±¼é¦™è‚‰ä¸ã€ç…§çƒ§é¸¡è‚‰ï¼‰
- è‡ªåˆ¶éƒ¨åˆ†ï¼šä½¿ç”¨ç®€å•ç›´ç™½çš„åç§°ï¼ˆå¦‚ï¼šç•ªèŒ„ç‚’è›‹ã€æ¸…ç‚’æ—¶è”¬ã€ç…®é¸¡è›‹ï¼‰

å‘½ååŸåˆ™ï¼š
1. å¤–é£Ÿèœå“ä½“ç°é¤é¦†æ°´å‡†ï¼Œåç§°ä¼˜é›…
2. è‡ªåˆ¶èœå“ä½“ç°å®¶å¸¸ä¾¿åˆ©ï¼Œåç§°å®ç”¨
3. æ•´ä½“é£æ ¼åè°ƒç»Ÿä¸€
''';
    } else {
      return '''
å®¶å¸¸èœå“å‘½åé£æ ¼ï¼ˆè¾ƒå¤šè‡ªå·±åš/åŸºæœ¬è‡ªå·±åšï¼‰ï¼š
âœ… ä½¿ç”¨ç®€å•ã€ç›´ç™½ã€å®ç”¨çš„èœå
âœ… çªå‡ºå®¶å¸¸èœçš„äº²åˆ‡æ„Ÿå’Œæ˜“æ“ä½œæ€§

å¸¸ç”¨ç¤ºä¾‹ï¼š
- ç•ªèŒ„ç‚’é¸¡è›‹
- æ¸…ç‚’æ—¶è”¬
- è’¸é±¼
- çº¢çƒ§è‚‰
- ç‚’é’èœ
- ç…®é¢æ¡
- ç…è›‹
- ç‚–æ±¤
- å‡‰æ‹Œé»„ç“œ
- è’œè“‰è¥¿å…°èŠ±

å‘½ååŸåˆ™ï¼š
1. çªå‡ºä¸»è¦é£Ÿæå’Œçƒ¹é¥ªæ–¹æ³•
2. ç®€å•æ˜äº†ï¼Œä¸€ç›®äº†ç„¶
3. ä½“ç°å®¶å¸¸èœçš„æ¸©é¦¨å’Œä¾¿åˆ©
4. é¿å…è¿‡äºå¤æ‚æˆ–åä¸½çš„åç§°
''';
    }
  }

  SnackRecommendationStrategy _getSnackRecommendation(String healthGoal) {
    switch (healthGoal) {
      case 'å‡è„‚':
        return SnackRecommendationStrategy(
          shouldRecommend: false,
          reason: '''
é›¶é£Ÿæ¨èç­–ç•¥ï¼šä¸æ¨èé›¶é£Ÿ

ç†ç”±ï¼š
- ç”¨æˆ·çš„å¥åº·ç›®æ ‡æ˜¯"å‡è„‚"ï¼Œéœ€è¦ä¸¥æ ¼æ§åˆ¶æ€»çƒ­é‡æ‘„å…¥
- é›¶é£Ÿå®¹æ˜“å¯¼è‡´é¢å¤–çƒ­é‡æ‘„å…¥ï¼Œä¸åˆ©äºå‡è„‚ç›®æ ‡
- å»ºè®®å°†çƒ­é‡é›†ä¸­åœ¨ä¸‰é¤ï¼Œä¿è¯é¥±è…¹æ„Ÿ

å¦‚æœç”¨æˆ·ç¡®å®éœ€è¦åŠ é¤ï¼Œå»ºè®®ï¼š
- åœ¨æè¿°ä¸­æåŠå¯ä»¥åœ¨ä¸¤é¤ä¹‹é—´é€‚é‡è¡¥å……ä½çƒ­é‡é£Ÿç‰©ï¼ˆå¦‚ï¼šé»„ç“œã€åœ£å¥³æœã€æ— ç³–é…¸å¥¶ï¼‰
- ä½†ä¸è¦å•ç‹¬ç”Ÿæˆ"é›¶é£Ÿ"è¿™ä¸€é¤æ¬¡
''',
        );

      case 'æ¸…æ±¤å¯¡æ¬²':
        return SnackRecommendationStrategy(
          shouldRecommend: false,
          reason: '''
é›¶é£Ÿæ¨èç­–ç•¥ï¼šä¸æ¨èé›¶é£Ÿ

ç†ç”±ï¼š
- ç”¨æˆ·é€‰æ‹©"æ¸…æ±¤å¯¡æ¬²"ï¼Œè¿½æ±‚æ¸…æ·¡é¥®é£Ÿå’Œä½çƒ­é‡æ‘„å…¥
- é›¶é£Ÿä¸ç¬¦åˆæ¸…æ·¡é¥®é£Ÿçš„ç†å¿µ
- å»ºè®®ä¸‰é¤ç®€å•æ¸…æ·¡å³å¯

å¦‚æœç”¨æˆ·ç¡®å®éœ€è¦åŠ é¤ï¼Œå»ºè®®ï¼š
- åœ¨æè¿°ä¸­æåŠå¯ä»¥é€‚é‡è¡¥å……æ°´æœæˆ–è”¬èœ
- ä½†ä¸è¦å•ç‹¬ç”Ÿæˆ"é›¶é£Ÿ"è¿™ä¸€é¤æ¬¡
''',
        );

      case 'å¢è‚Œ':
        return SnackRecommendationStrategy(
          shouldRecommend: true,
          reason: '''
é›¶é£Ÿæ¨èç­–ç•¥ï¼šæ¨èå¥åº·é›¶é£Ÿ

ç†ç”±ï¼š
- ç”¨æˆ·çš„å¥åº·ç›®æ ‡æ˜¯"å¢è‚Œ"ï¼Œéœ€è¦å……è¶³çš„çƒ­é‡å’Œè›‹ç™½è´¨
- é€‚å½“çš„åŠ é¤æœ‰åŠ©äºä¿æŒèƒ½é‡ä¾›åº”ï¼Œæ”¯æŒè‚Œè‚‰ç”Ÿé•¿
- è®­ç»ƒåè¡¥å……è›‹ç™½è´¨å’Œç¢³æ°´éå¸¸é‡è¦

æ¨èé›¶é£Ÿç±»å‹ï¼š
- é«˜è›‹ç™½é›¶é£Ÿï¼ˆè›‹ç™½æ£’ã€é¸¡è›‹ã€ç‰›è‚‰å¹²ã€å¸Œè…Šé…¸å¥¶ï¼‰
- åšæœç±»ï¼ˆæ ¸æ¡ƒã€æä»ã€è…°æœï¼‰
- æ°´æœæ­é…é…¸å¥¶
- å…¨éº¦é¢åŒ…é…èŠ±ç”Ÿé…±

è¯·åœ¨JSONä¸­åŒ…å«"é›¶é£Ÿ"è¿™ä¸€é¤æ¬¡ã€‚
''',
        );

      case 'èƒ¡åƒæµ·å¡':
        return SnackRecommendationStrategy(
          shouldRecommend: true,
          reason: '''
é›¶é£Ÿæ¨èç­–ç•¥ï¼šæ¨èå„ç§é›¶é£Ÿ

ç†ç”±ï¼š
- ç”¨æˆ·é€‰æ‹©"èƒ¡åƒæµ·å¡"ï¼Œè¿½æ±‚ç¾é£Ÿäº«å—
- å¯ä»¥æ¨èå„ç§ç¾å‘³é›¶é£Ÿï¼Œæ»¡è¶³å£è…¹ä¹‹æ¬²
- ä¸é™åˆ¶çƒ­é‡å’Œç±»å‹

æ¨èé›¶é£Ÿç±»å‹ï¼š
- ç”œç‚¹ï¼ˆè›‹ç³•ã€å†°æ·‡æ·‹ã€å¸ƒä¸ã€é©¬å¡é¾™ã€å¥¶èŒ¶ï¼‰
- å°åƒï¼ˆç‚¸é¸¡ã€è–¯æ¡ã€çˆ†ç±³èŠ±ã€æŠ«è¨ï¼‰
- é¥®æ–™ï¼ˆå¥¶èŒ¶ã€æœæ±ã€å’–å•¡ã€å¥¶æ˜”ï¼‰
- æ°´æœï¼ˆå„ç§æ–°é²œæ°´æœï¼‰
- å…¶ä»–ç¾é£Ÿï¼ˆé›¶é£Ÿã€ç³–æœã€å·§å…‹åŠ›ï¼‰

è¯·åœ¨JSONä¸­åŒ…å«"é›¶é£Ÿ"è¿™ä¸€é¤æ¬¡ï¼Œé£æ ¼å¯ä»¥ä¸°å¯Œå¤šæ ·ã€‚
''',
        );

      case 'ç»´æŒ':
      case 'éšæ„':
      default:
        return SnackRecommendationStrategy(
          shouldRecommend: true,
          reason: '''
é›¶é£Ÿæ¨èç­–ç•¥ï¼šæ¨èé€‚é‡å¥åº·é›¶é£Ÿ

ç†ç”±ï¼š
- ç”¨æˆ·çš„å¥åº·ç›®æ ‡æ˜¯"${healthGoal}"ï¼Œå…è®¸é€‚åº¦çš„é›¶é£Ÿæ‘„å…¥
- å¥åº·é›¶é£Ÿå¯ä»¥è¡¥å……è¥å…»ï¼Œç¼“è§£é¥¥é¥¿
- æœ‰åŠ©äºç»´æŒè‰¯å¥½çš„é¥®é£Ÿä¹ æƒ¯

æ¨èé›¶é£Ÿç±»å‹ï¼š
- åšæœç±»ï¼ˆé€‚é‡ï¼Œæ§åˆ¶ä»½é‡ï¼‰
- æ–°é²œæ°´æœ
- é…¸å¥¶
- å…¨éº¦é¥¼å¹²
- è”¬èœæ¡é…å¥åº·é…±æ–™

è¯·åœ¨JSONä¸­åŒ…å«"é›¶é£Ÿ"è¿™ä¸€é¤æ¬¡ï¼Œæ³¨æ„æ§åˆ¶çƒ­é‡å’Œä»½é‡ã€‚
''',
        );
    }
  }

  int _getExamplePrice(String city, String mealType, int mealSource) {
    if (mealSource >= 4) {
      return mealType == 'breakfast' ? 10 : (mealType == 'lunch' ? 20 : 18);
    }

    final cityLower = city.toLowerCase();

    if (cityLower.contains('æ—§é‡‘å±±') || cityLower.contains('san francisco') ||
        cityLower.contains('æ¹¾åŒº') || cityLower.contains('bay area')) {
      if (mealType == 'breakfast') return 15;
      if (mealType == 'lunch') return 30;
      return 40;
    } else if (cityLower.contains('æ´›æ‰çŸ¶') || cityLower.contains('los angeles')) {
      if (mealType == 'breakfast') return 12;
      if (mealType == 'lunch') return 25;
      return 30;
    } else if (cityLower.contains('å‡¤å‡°åŸ') || cityLower.contains('phoenix')) {
      if (mealType == 'breakfast') return 8;
      if (mealType == 'lunch') return 15;
      return 20;
    } else {
      if (mealType == 'breakfast') return 25;
      if (mealType == 'lunch') return 40;
      return 50;
    }
  }

  String _getMealSourceText(int level) {
    const texts = {
      1: 'åŸºæœ¬å¤–é£Ÿ',
      2: 'è¾ƒå¤šå¤–é£Ÿ',
      3: 'å¯¹åŠ',
      4: 'è¾ƒå¤šè‡ªå·±åš',
      5: 'åŸºæœ¬è‡ªå·±åš',
    };
    return texts[level] ?? 'æœªè®¾ç½®';
  }

  String _getExampleSetName(String healthGoal) {
    switch (healthGoal) {
      case 'å‡è„‚':
        return 'è½»ç›ˆå‡è„‚å¥—é¤';
      case 'å¢è‚Œ':
        return 'å¼ºå¥å¢è‚Œå¥—é¤';
      case 'ç»´æŒ':
        return 'å‡è¡¡å¥åº·å¥—é¤';
      case 'èƒ¡åƒæµ·å¡':
        return 'ä¸°ç››ç¾é£Ÿå¥—é¤';
      case 'æ¸…æ±¤å¯¡æ¬²':
        return 'æ¸…æ·¡å…»ç”Ÿå¥—é¤';
      default:
        return 'å¥åº·æ´»åŠ›å¥—é¤';
    }
  }

  Future<Map<String, dynamic>> _callOpenAI(String prompt, String model) async {
    try {
      final response = await http.post(
        Uri.parse(_API_URL),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $_apiKey',
        },
        body: jsonEncode({
          'model': model,
          'messages': [
            {
              'role': 'system',
              'content': '''ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è¥å…»å¸ˆå’Œå¥åº·é¡¾é—®ï¼Œæ“…é•¿æ ¹æ®ç”¨æˆ·çš„èº«ä½“çŠ¶å†µã€å¥åº·ç›®æ ‡å’Œé¥®é£Ÿåå¥½æä¾›ç§‘å­¦ã€ä¸ªæ€§åŒ–çš„é¤é£Ÿæ¨èæ–¹æ¡ˆã€‚

æ ¸å¿ƒåŸåˆ™ï¼š
1. ä¸¥æ ¼éµå¾ªç”¨æˆ·çš„é€‰æ‹©å’Œåå¥½
2. ç¾å‘³ä¸å¥åº·å¹¶é‡ï¼Œæ ¹æ®ç”¨æˆ·ç›®æ ‡è°ƒæ•´æ¯”ä¾‹
3. æ¨èçœŸå®å­˜åœ¨çš„é¤é¦†èœå“ï¼ˆå¦‚æœç”¨æˆ·é€‰æ‹©å¤–é£Ÿï¼‰
4. ä»·æ ¼ç¬¦åˆå½“åœ°æ¶ˆè´¹æ°´å¹³
5. é¿å¼€å¿Œå£å’Œå¥åº·ç¦å¿Œ''',
            },
            {
              'role': 'user',
              'content': prompt,
            },
          ],
          'temperature': 0.8,
          'max_tokens': 4000,
        }),
      ).timeout(const Duration(seconds: 60));

      if (response.statusCode == 200) {
        return jsonDecode(utf8.decode(response.bodyBytes));
      } else {
        throw Exception('APIè°ƒç”¨å¤±è´¥: ${response.statusCode} - ${response.body}');
      }
    } catch (e) {
      throw Exception('APIè°ƒç”¨é”™è¯¯: $e');
    }
  }

  List<List<RecommendedMeal>> _parseRecommendationSets(
    Map<String, dynamic> response,
    int expectedSetsCount,
  ) {
    try {
      final content = response['choices'][0]['message']['content'] as String;

      String jsonContent = content.trim();
      if (jsonContent.startsWith('```json')) {
        jsonContent = jsonContent.substring(7);
      }
      if (jsonContent.startsWith('```')) {
        jsonContent = jsonContent.substring(3);
      }
      if (jsonContent.endsWith('```')) {
        jsonContent = jsonContent.substring(0, jsonContent.length - 3);
      }
      jsonContent = jsonContent.trim();

      final data = jsonDecode(jsonContent);
      final List<dynamic> recommendationSets = data['recommendation_sets'];

      if (recommendationSets.length != expectedSetsCount) {
        print('âš ï¸ è­¦å‘Šï¼šé¢„æœŸ $expectedSetsCount å¥—ï¼Œå®é™…è¿”å› ${recommendationSets.length} å¥—');
      }

      return recommendationSets.map<List<RecommendedMeal>>((setJson) {
        final int setNumber = setJson['set_number'];
        final String setName = setJson['set_name'] ?? 'æ–¹æ¡ˆ $setNumber';
        final List<dynamic> meals = setJson['meals'];

        return meals.map<RecommendedMeal>((mealJson) {
          return RecommendedMeal(
            id: DateTime.now().millisecondsSinceEpoch.toString() +
                '_set${setNumber}_' +
                mealJson['mealType'],
            mealType: mealJson['mealType'],
            name: mealJson['name'],
            description: '$setName - ${mealJson['description'] ?? ''}',
            ingredients: (mealJson['ingredients'] as List<dynamic>)
                .map((e) => e.toString())
                .toList(),
            nutrition: Nutrition.fromJson(mealJson['nutrition']),
            estimatedROI: mealJson['estimatedROI'],
            cookingTips: mealJson['cookingTips'],
            cookingTime: mealJson['cookingTime'],
            sourceModel: 'gpt-3.5-turbo',
          );
        }).toList();
      }).toList();
    } catch (e) {
      throw Exception('è§£æAIå“åº”å¤±è´¥: $e');
    }
  }
}

class SnackRecommendationStrategy {
  final bool shouldRecommend;
  final String reason;

  SnackRecommendationStrategy({
    required this.shouldRecommend,
    required this.reason,
  });

  @override
  String toString() => reason;
}